<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="../../bower_components/dom-if-else/dom-if-else.html">

<link rel="import" href="../project-card/project-card.html">
<link rel="import" href="../checklist-card/checklist-card.html">
<link rel="import" href="../linter-card/linter-card.html">

<script src="../../bower_components/underscore.string/dist/underscore.string.min.js"></script>
<script src="../../bower_components/blend.js/lib/blend.min.js"></script>

<dom-module id="project-info">
  <template>
    <style include="shared-styles">
      @import "breakpoints";

      :host {
        position: relative;
        display: block;
      }
      :host .Project-row {
        @apply(--layout-horizontal);
        @media (--sm-viewport) {
          @apply(--layout-vertical);
        }
        @media (max-width: 880px) {
          @apply(--layout-vertical);
        }
      }
      :host project-card, :host checklist-card, :host linter-card {
        margin: 15px 16px 0 16px;
        padding: 16px;
        text-align: center;
        @apply(--layout-flex);
      }
      :host linter-card {
        display: none;
      }
      :host paper-progress {
        --paper-progress-height: 3px;
      }
      :host .explore {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        flex-direction: column !important;
        -webkit-flex-direction: column !important;
        -ms-flex-direction: column !important;
        --paper-button: {
          font-size: 20px;
          margin: 15px 16px 0 16px;
        }
      }
      :host .explore paper-progress {
        --paper-progress-container-color: var(--default-primary-color);
        --paper-progress-active-color: var(--light-primary-color);
        margin: 0 auto;
        width: 100px;
      }
    </style>

    <iron-meta key="linterResults" value="{{linterResults}}"></iron-meta>
    <iron-ajax id="queryRepoValid" handle-as="json" on-response="_handleRepoValid" on-error="_handleRepoValid"></iron-ajax>
    <iron-ajax id="query" handle-as="json" on-response="_handleLinter" on-error="_handleLinterError"></iron-ajax>
    <iron-ajax id="rank" handle-as="json" on-response="_handleRank" on-error="_handleRank"></iron-ajax>

    <div class="Project-badges">
      <template is="dom-if" if="{{_data.rank}}">
        <img src="{{app.SERVICE_HOST}}/{{repository}}/badge/rank">
      </template>
    </div>

    <template is="dom-if-else" if="{{_repoValid}}">
      <if-then>
        <section class="Project-details">
          <div class="Project-row">
            <project-card title="Total/Average Lines" content="{{_data.loc.totalAvgLoc}}" help="Total lines of code and average lines of code per file" linter="loc"></project-card>
            <project-card title="Ratio LOC/CLOC" content="{{_data.loc.ratioLocCloc}}" help="Ratio between lines of code and lines of comment" linter="loc"></project-card>
            <project-card title="Third Parties" content="{{_data.imports.thirdPartiesCount}}" help="How many third party libraries are used" linter="imports"></project-card>
            <checklist-card title="Checklist Compliance" content="{{_data.test.checklist}}" help="Compliance with a few items from the Go checklist" linter="test" data="{{_rawData.test.checklist}}">
            </checklist-card>
          </div>
          <div class="Project-row">
            <project-card title="Tests" content="{{_data.loc.tests}}" icon="{{_testsIcon}}" icon-tooltip="{{_testsIconTooltip}}" help="How many tests across all packages" linter="loc"></project-card>
            <project-card title="Test Coverage" content="{{_data.test.coverageMean}}" help="Average code coverage across all packages" linter="test"></project-card>
            <project-card title="Test Duration" content="{{_data.test.durationMean}}" help="The time it took to run all tests" linter="test"></project-card>
            <project-card title="Project Rating" content="{{_data.rank}}" help="Rank calculated from the metrics visible here" linter="test"></project-card>
          </div>

          <paper-button noink class="explore" on-click="_showResults" disabled>
            <div>Loading</div>
            <paper-progress value="{{_linterProgress}}" max="{{linters.length}}"></paper-progress>
          </paper-button>
          <linter-card id="linterCard" repository="{{repository}}" class="Project-block" linters="{{linters}}"></linter-card>
        </section>
      </if-then>
      <if-else>
        <template is="dom-if-else" if="{{_loading}}">
          <if-then>
            <paper-progress indeterminate></paper-progress>
          </if-then>
          <if-else>
            <div class="Message">
              <iron-icon icon="error-outline"></iron-icon>
              <div class="Message-contents">
                <h2>Oops!</h2>
                <p>{{_errorMessage}}</p>
              </div>
            </div>
          </if-else>
        </template>
      </if-else>
    </template>
  </template>

  <script src="project-info.js"></script>
</dom-module>
