<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">

<link rel="import" href="../../bower_components/dom-if-else/dom-if-else.html">

<link rel="import" href="../project-card/project-card.html">
<link rel="import" href="../linter-card/linter-card.html">
<link rel="import" href="../common-styles.html">

<script src="../../bower_components/underscore.string/dist/underscore.string.min.js"></script>
<script src="../../bower_components/blend.js/lib/blend.min.js"></script>

<dom-module id="project-info">
  <template>
    <style include="common-styles">
      :host {
        position: relative;
        display: block;
      }
      :host paper-progress {
        --paper-progress-height: 3px;
      }
      :host project-card, :host linter-card {
        margin: 15px 16px 0 16px;
        padding: 16px;
        @apply(--layout-flex);
        text-align: center;
      }
      :host linter-card {
        display: none;
      }
      :host .explore {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        flex-direction: column !important;
        -webkit-flex-direction: column !important;
        -ms-flex-direction: column !important;
        --paper-button: {
          font-size: 20px;
          margin: 15px 16px 0 16px;
        }
      }
      :host .explore paper-progress {
        --paper-progress-container-color: var(--default-primary-color);
        --paper-progress-active-color: var(--light-primary-color);
        margin: 0 auto;
        width: 100px;
      }
    </style>

    <iron-meta key="linterResults" value="{{linterResults}}"></iron-meta>
    <iron-ajax id="queryRepoExists" handle-as="json" on-response="_handleRepoExists" on-error="_handleRepoExists"></iron-ajax>
    <iron-ajax id="query" handle-as="json" on-response="_handleLinter" on-error="_handleLinterError"></iron-ajax>

    <template is="dom-if-else" if="{{_repoExists}}">
      <if-then>
        <section class="Project-details">
          <div class="layout horizontal">
            <project-card title="Total/Average Lines" content="{{_data.loc.totalAvgLoc}}" help="Total lines of code and average lines of code per file" linter="loc"></project-card>
            <project-card title="Ratio LOC/CLOC" content="{{_data.loc.ratioLocCloc}}" help="Ratio between lines of code and lines of comment" linter="loc"></project-card>
            <project-card title="Third Parties" content="{{_data.imports.thirdPartiesCount}}" help="How many third party libraries are used" linter="imports"></project-card>
            <project-card title="Checklist Compliance" content="{{_data.test.checklist}}" help="Compliance with a few items from the Go checklist" linter="test"></project-card>
          </div>
          <div class="layout horizontal">
            <project-card title="Tests" content="{{_data.loc.tests}}" icon="{{_testsIcon}}" icon-tooltip="{{_testsIconTooltip}}" help="How many tests across all packages" linter="loc"></project-card>
            <project-card title="Test Coverage" content="{{_data.test.coverageMean}}" help="Average code coverage across all packages" linter="test"></project-card>
            <project-card title="Test Duration" content="{{_data.test.durationMean}}" help="The time it took to run all tests with the following configuration: i5 - 512MB" linter="test"></project-card>
            <project-card title="Project Rating" content="{{_data.rating}}" help="Global rating based on the few metrics visible here" linter="test"></project-card>
          </div>

          <paper-button raised noink class="explore" on-click="_showResults" disabled>
            <div>Explore</div>
            <paper-progress value="{{_linterProgress}}" max="{{linters.length}}"></paper-progress>
          </paper-button>
          <linter-card id="linterCard" repository="{{repository}}" class="Project-block" linters="{{linters}}"></linter-card>
        </section>
      </if-then>
      <if-else>
        <template is="dom-if-else" if="{{_loading}}">
          <if-then>
            <paper-progress indeterminate></paper-progress>
          </if-then>
          <if-else>
            <div class="Message">
              <iron-icon icon="error-outline"></iron-icon>
              <div class="Message-contents">
                <h2>Oops!</h2>
                <p>{{_errorMessage}}</p>
              </div>
            </div>
          </if-else>
        </template>
      </if-else>
    </template>
  </template>

  <script src="project-info.js"></script>

</dom-module>
